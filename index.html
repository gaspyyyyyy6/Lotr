<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive - Terre du Milieu</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map', {
            minZoom: 2,
            maxZoom: 5,
            center: [0, 0],
            zoom: 2,
            crs: L.CRS.Simple
        });
        
        var imageUrl = 'https://i.imgur.com/d0lSTs8.jpeg';
        var imageBounds = [[-100, -137], [100, 137]];
        L.imageOverlay(imageUrl, imageBounds).addTo(map);
        map.fitBounds(imageBounds);

        function ajouterPoint(lat, lon, nom, couleur, emoji) {
            let icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="font-size: 20px; color: ${couleur};">${emoji}</div>`
            });
            
            let marker = L.marker([lat, lon], { icon: icon, draggable: true }).addTo(map)
              .bindPopup(`<b>${nom}</b>`);
            
            marker.on('dragend', sauvegarderPoints);
            marker.on('click', function () {
                map.removeLayer(marker);
                sauvegarderPoints();
            });
            sauvegarderPoints();
        }

        function sauvegarderPoints() {
            let points = [];
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    points.push({
                        lat: layer.getLatLng().lat,
                        lon: layer.getLatLng().lng,
                        nom: layer.getPopup().getContent().replace('<b>', '').replace('</b>', ''),
                        couleur: layer.options.icon.options.html.match(/color: (.*?);/)[1],
                        emoji: layer.options.icon.options.html.match(/>(.*?)<\/div>/)[1]
                    });
                }
            });
            localStorage.setItem('pointsCarte', JSON.stringify(points));
        }

        function chargerPoints() {
            let points = JSON.parse(localStorage.getItem('pointsCarte')) || [];
            points.forEach(point => {
                ajouterPoint(point.lat, point.lon, point.nom, point.couleur, point.emoji);
            });
        }

        map.on('click', function (e) {
            let nom = prompt("Nom du point :");
            let couleur = prompt("Couleur du point (red, blue, green, yellow, white) :", "red");
            let emoji = prompt("Emoji du point :", "⚔️");
            if (nom) {
                ajouterPoint(e.latlng.lat, e.latlng.lng, nom, couleur, emoji);
            }
        });

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                remove: true
            },
            draw: {
                polygon: true,
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            let couleur = prompt("Couleur de la zone (ex: #FF0000) :", "#FF0000");
            let nom = prompt("Nom de la zone :");
            
            if (nom && couleur) {
                layer.setStyle({ fillColor: couleur, color: couleur, fillOpacity: 0.4 });
                layer.bindPopup(`<b>${nom}</b>`).openPopup();
                drawnItems.addLayer(layer);
                sauvegarderZones();
            }
        });

        function sauvegarderZones() {
            let zones = [];
            drawnItems.eachLayer(function(layer) {
                zones.push({
                    latlngs: layer.getLatLngs(),
                    couleur: layer.options.fillColor,
                    nom: layer.getPopup().getContent().replace('<b>', '').replace('</b>', '')
                });
            });
            localStorage.setItem('zonesCarte', JSON.stringify(zones));
        }

        function chargerZones() {
            let zones = JSON.parse(localStorage.getItem('zonesCarte')) || [];
            zones.forEach(zone => {
                let polygon = L.polygon(zone.latlngs, { fillColor: zone.couleur, color: zone.couleur, fillOpacity: 0.4 });
                polygon.bindPopup(`<b>${zone.nom}</b>`);
                drawnItems.addLayer(polygon);
            });
        }

        chargerPoints();
        chargerZones();
    </script>
</body>
</html>
