<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive - Terre du Milieu</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        .menu {
            position: absolute;
            top: 50%;
            right: -200px;
            width: 200px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 1000;
            transition: right 0.3s;
        }
        .menu.active {
            right: 0;
        }
        .menu-toggle {
            position: absolute;
            top: 50%;
            right: 0;
            background: white;
            padding: 5px;
            border-radius: 5px 0 0 5px;
            cursor: pointer;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        .color-picker, .emoji-picker {
            display: flex;
            gap: 5px;
        }
        .color-picker button, .emoji-picker button {
            width: 30px;
            height: 30px;
            border: none;
            cursor: pointer;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="menu-toggle" onclick="toggleMenu()">▶</div>
    <div class="menu" id="menu">
        <button onclick="activerMode('point')">Ajouter un point</button>
        <button onclick="activerMode('territoire')">Dessiner un territoire</button>
        <div id="options-point" style="display: none;">
            <div class="color-picker" id="colorPicker"></div>
            <div class="emoji-picker" id="emojiPicker"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script>
        var map = L.map('map', {
            minZoom: 2,
            maxZoom: 5,
            center: [0, 0],
            zoom: 2,
            crs: L.CRS.Simple
        });
        
        var imageUrl = 'https://i.imgur.com/d0lSTs8.jpeg';
        var imageBounds = [[-100, -137], [100, 137]];
        L.imageOverlay(imageUrl, imageBounds).addTo(map);
        map.fitBounds(imageBounds);

        let mode = null;
        let selectedColor = 'red';
        let selectedEmoji = '⚔️';

        function toggleMenu() {
            let menu = document.getElementById('menu');
            menu.classList.toggle('active');
        }

        function activerMode(nouveauMode) {
            mode = nouveauMode;
            document.getElementById('options-point').style.display = (mode === 'point') ? 'block' : 'none';
        }

        function ajouterPoint(lat, lon, nom) {
            let icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="font-size: 20px; color: ${selectedColor};">${selectedEmoji}</div>`
            });
            
            let marker = L.marker([lat, lon], { icon: icon, draggable: true }).addTo(map)
              .bindPopup(`<b>${nom}</b>`);
            
            marker.on('dragend', sauvegarderPoints);
            marker.on('click', function () {
                map.removeLayer(marker);
                sauvegarderPoints();
            });
            sauvegarderPoints();
        }

        function sauvegarderPoints() {
            let points = [];
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    points.push({
                        lat: layer.getLatLng().lat,
                        lon: layer.getLatLng().lng,
                        nom: layer.getPopup().getContent().replace('<b>', '').replace('</b>', ''),
                        couleur: selectedColor,
                        emoji: selectedEmoji
                    });
                }
            });
            localStorage.setItem('pointsCarte', JSON.stringify(points));
        }

        function chargerPoints() {
            let points = JSON.parse(localStorage.getItem('pointsCarte')) || [];
            points.forEach(point => {
                ajouterPoint(point.lat, point.lon, point.nom);
            });
        }

        map.on('click', function (e) {
            if (mode === 'point') {
                let nom = prompt("Nom du point :");
                if (nom) {
                    ajouterPoint(e.latlng.lat, e.latlng.lng, nom);
                }
            }
        });

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                remove: true
            },
            draw: {
                polygon: true,
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false
            }
        });
        
        map.addControl(drawControl);
        
        map.on(L.Draw.Event.CREATED, function (event) {
            if (mode === 'territoire') {
                var layer = event.layer;
                let couleur = prompt("Couleur de la zone (ex: #FF0000) :", "#FF0000");
                let nom = prompt("Nom de la zone :");
                
                if (nom && couleur) {
                    layer.setStyle({ fillColor: couleur, color: couleur, fillOpacity: 0.4 });
                    layer.bindPopup(`<b>${nom}</b>`).openPopup();
                    drawnItems.addLayer(layer);
                    sauvegarderZones();
                }
            }
        });

        function sauvegarderZones() {
            let zones = [];
            drawnItems.eachLayer(function(layer) {
                zones.push({
                    latlngs: layer.getLatLngs(),
                    couleur: layer.options.fillColor,
                    nom: layer.getPopup().getContent().replace('<b>', '').replace('</b>', '')
                });
            });
            localStorage.setItem('zonesCarte', JSON.stringify(zones));
        }

        function chargerZones() {
            let zones = JSON.parse(localStorage.getItem('zonesCarte')) || [];
            zones.forEach(zone => {
                let polygon = L.polygon(zone.latlngs, { fillColor: zone.couleur, color: zone.couleur, fillOpacity: 0.4 });
                polygon.bindPopup(`<b>${zone.nom}</b>`);
                drawnItems.addLayer(polygon);
            });
        }

        chargerPoints();
        chargerZones();
    </script>
</body>
</html>
